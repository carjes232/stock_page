services:
  db:
    image: cockroachdb/cockroach:v24.1.2
    command: start-single-node --insecure --http-addr=0.0.0.0:8081 --sql-addr=0.0.0.0:26259
    ports:
      - "26258:26259"
      - "8082:8081"
    volumes:
      - crdb-data:/cockroach/cockroach-data
    healthcheck:
      test: ["CMD-SHELL", "curl -fsS http://localhost:8081/health?ready=1 || exit 1"]
      interval: 5s
      timeout: 3s
      retries: 60

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    environment:
      - DB_URL
      - API_BASE
      - API_TOKEN
      - FMP_API_KEY
      - DISABLE_GRAHAM_PROVIDER
      - FUNDAMENTALS_API_BASE
      - PRICE_TOPK
      - QUOTES_TTL
      - BACKEND_PORT
      - INGEST_INTERVAL
      - INGEST_ON_START
      - GEMINI_API_KEY
      - GEMINI_MODEL_ID
      - QUOTES_MIN_REFRESH_AGE
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "${BACKEND_PORT}:8080"
    restart: unless-stopped

  fundamentals-api:
    build:
      context: ./backend
      dockerfile: Dockerfile.python
    command: ["python", "fundamentals_api.py"]
    environment:
      - DB_URL
      - ALPHAVANTAGE_KEY
      - PORT=9000
    volumes:
      - ./backend:/app:ro
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped
    ports:
      - "9000:9000"

  fundamentals-scheduler:
    build:
      context: ./backend
      dockerfile: Dockerfile.python
    command: ["python", "scheduler.py"]
    environment:
      - FUNDAMENTALS_API_BASE=http://fundamentals-api:9000
      - FUNDAMENTALS_SYMBOLS
      - FUNDAMENTALS_USE_FINAL_METRIC
      - PRICE_UPDATE_INTERVAL
      - FUNDAMENTALS_UPDATE_INTERVAL
      - TOP_RECENT_COUNT
      - DB_URL
    volumes:
      - ./backend:/app:ro
    depends_on:
      db:
        condition: service_healthy
      fundamentals-api:
        condition: service_started
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        VITE_API_BASE: "${VITE_API_BASE}"
        VITE_PORT: "${FRONTEND_PORT}"
    environment:
      - FRONTEND_PORT
      - VITE_API_BASE
    depends_on:
      - backend
    ports:
      - "${FRONTEND_PORT}:${FRONTEND_PORT}"
    restart: unless-stopped

volumes:
  crdb-data:
